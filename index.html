<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Power_Test_Object_028</title>
<style>
body,html{margin:0;padding:0;height:100%;overflow:hidden;background:#fff;}
#game{display:flex;flex-direction:column;height:100%;position:relative;}
canvas{width:100%;flex:1;}
#records{position:absolute;top:10px;right:10px;color:#000;font-family:sans-serif;font-size:14px;background:rgba(255,255,255,0.7);padding:8px;border-radius:8px;max-height:90%;overflow-y:auto;}
h2{margin:0 0 5px 0;font-size:16px;}
ul{margin:0;padding-left:15px;list-style:none;}
li{margin:2px 0;}
</style>
</head>
<body>
<div id="game">
<canvas id="c"></canvas>
<div id="records">
<h2>Рекорды</h2>
<ul id="list"></ul>
</div>
</div>

<script>
const BASE_TARGET_BOOST = 0.02;
const BOOST_REDUCTION = 0.009;
const FALL_SPEED = 0.075;
const EASE_FACTOR = 0.1;
const SHAKE_AMOUNT = 3;
const SHAKE_SPEED = 1.2;
const TAP_TIMEOUT = 0.4;
const BOTTOM_OFFSET = 0.02;
const TOP_OFFSET = 0.01;
const MAX_SCORE = 1000000;

const bgImg = new Image();
bgImg.src = "bg.png";

const charImg = new Image();
charImg.src = "char.png";

const c = document.getElementById("c");
const ctx = c.getContext("2d");
const list = document.getElementById("list");

let currentPos = 0;
let targetPos = 0;
let shakeTime = 0;
let score = 0;
let gameOver = false;
let maxReached = false;
let charSize = 0;
let playableHeight = 0;
let lastTapTime = 0;

function resize() {
  c.width = window.innerWidth;
  c.height = window.innerHeight;
  playableHeight = c.height * (1 - BOTTOM_OFFSET - TOP_OFFSET);
}
window.onresize = resize;
resize();

localStorage.removeItem("liftRecords");

let records = [];
function showRecords() {
  list.innerHTML = "";
  records.slice(0, 10).forEach(r => {
    const li = document.createElement("li");
    li.textContent = (r/1000).toFixed(0) + "к";
    list.appendChild(li);
  });
}

function saveRecords() {
  if (score > 0) {
    records.push(score);
    records.sort((a, b) => b - a);
    records = records.slice(0, 10);
    localStorage.setItem("liftRecords", JSON.stringify(records));
    showRecords();
  }
}

function tap(e) {
  e.preventDefault();
  if (gameOver) {
    currentPos = targetPos = 0;
    score = 0;
    gameOver = false;
    maxReached = false;
  } else {
    const boost = BASE_TARGET_BOOST - BOOST_REDUCTION * targetPos;
    targetPos = Math.min(targetPos + boost, 1);
    shakeTime = 0;
  }
  lastTapTime = performance.now() / 1000;
}

c.onclick = tap;
c.ontouchstart = tap;

let lastTime = performance.now();
function loop(time) {
  const currentTime = time / 1000;
  const dt = (time - lastTime) / 1000;
  lastTime = time;

  ctx.clearRect(0, 0, c.width, c.height);

  if (bgImg.complete) {
    const bgRatio = bgImg.naturalWidth / bgImg.naturalHeight || 1;
    const canvasRatio = c.width / c.height;
    let bw, bh, bx = 0, by = 0;
    if (bgRatio > canvasRatio) {
      bw = c.width;
      bh = c.width / bgRatio;
      by = (c.height - bh) / 2;
    } else {
      bh = c.height;
      bw = c.height * bgRatio;
      bx = (c.width - bw) / 2;
    }
    ctx.drawImage(bgImg, bx, by, bw, bh);
  }

  charSize = Math.min(c.width * 0.25, c.height * 0.25);

  if (!gameOver) {
    currentPos += (targetPos - currentPos) * EASE_FACTOR;
    targetPos = Math.max(targetPos - FALL_SPEED * dt, 0);

    if (currentTime - lastTapTime < TAP_TIMEOUT) {
      shakeTime += dt * SHAKE_SPEED;
    } else {
      shakeTime = 0;
    }

    if (currentTime - lastTapTime > TAP_TIMEOUT && score > 0) {
      gameOver = true;
      saveRecords();
      targetPos = 0;
    }

    if (currentPos >= 0.999 && !maxReached) {
      maxReached = true;
      gameOver = true;
      saveRecords();
      targetPos = 1;
    }

    score = Math.round(currentPos * MAX_SCORE);
  }

  const shakeX = (currentTime - lastTapTime < TAP_TIMEOUT) ? Math.sin(shakeTime * 50) * SHAKE_AMOUNT : 0;
  const shakeY = (currentTime - lastTapTime < TAP_TIMEOUT) ? Math.cos(shakeTime * 60) * SHAKE_AMOUNT * 0.5 : 0;

  const y = c.height - BOTTOM_OFFSET * c.height - currentPos * playableHeight - charSize + shakeY;

  if (charImg.complete) {
    const x = c.width / 2 - charSize / 2 + shakeX;
    ctx.drawImage(charImg, x, y, charSize, charSize);
  }

  // Очки слева сверху
  ctx.fillStyle = "#000";
  ctx.font = "bold 24px sans-serif";
  ctx.textAlign = "left";
  ctx.fillText(score.toLocaleString() + " очков", 20, 40);

  // Экран окончания — строго по центру
  if (gameOver) {
    ctx.fillStyle = "rgba(255,255,255,0.9)";
    ctx.fillRect(c.width * 0.1, c.height / 2 - 100, c.width * 0.8, 200);

    ctx.fillStyle = "#000";
    ctx.textAlign = "center";
    ctx.font = "bold 32px sans-serif";
    if (maxReached) {
      ctx.fillText("Отличный результат, 028!", c.width / 2, c.height / 2 - 30);
    } else {
      ctx.fillText("Испытание окончено", c.width / 2, c.height / 2 - 30);
    }

    ctx.font = "24px sans-serif";
    ctx.fillText("Нажми для начала", c.width / 2, c.height / 2 + 30);
  }

  requestAnimationFrame(loop);
}

function startIfReady() {
  if (bgImg.complete && charImg.complete) {
    requestAnimationFrame(loop);
  }
}
bgImg.onload = startIfReady;
charImg.onload = startIfReady;
if (bgImg.complete && charImg.complete) startIfReady();

showRecords();
</script>
</body>
</html>
